<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=EmulateIE9">
    <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0' name='viewport'/>
    <title>AppThing</title>
    <link rel="icon" type="image/png" href="img/mobile/favicon.ico">

    <!--Fonts CSS-->
    <link rel="stylesheet" type="text/css" href="css/roboto.css">
    <link rel="stylesheet" type="text/css" href="css/raleway.css">
    <link rel="stylesheet" type="text/css" href="css/open-sans.css">
    <link rel="stylesheet" type="text/css" href="css/font-awesome.min.css"/>
    <link rel="stylesheet" type="text/css" href="css/bootstrap-3.3.6/css/bootstrap.min.css">

    <!--Custom CSS-->
    <link rel="stylesheet" type="text/css" href="css/iot-app.css">
</head>
<body>
<header>
    <div id="container">
        <input id="toggle" type="checkbox"><label for="toggle">&equiv;</label>

        <div class="content">
            <div class="header-topic">View Timers</div>
            <div class="set-timer-plus"><a href="./set-timer.html"><img src="img/mobile/plus.png"></a></div>
        </div>
        <div class="slide-menu">
            <div class="slide-menu__logo">
                <img src="img/mobile/logo-48x48.png">

                <h2>AppThing Dashboard</h2>
            </div>
            <nav class="menu">
                <li><a href="./things.html">Things</a></li>
                <li><a href="./view-timers.html">View Timers</a></li>
                <li><a href="./set-timer.html">Set Timer</a></li>
                <li><a href="./history.html">History</a></li>
                <li><a id="logout" href="index.html">Log Out</a></li>
            </nav>
        </div>
    </div>
</header>
<div class="iot-app-block">
</div>
<script type="text/javascript" src="js/jquery-1.11.3.min.js"></script>
<script type="text/javascript" src="js/bootstrap-3.3.6/js/bootstrap.min.js"></script>
<script type="text/javascript" src="js/bootstrap-3.3.6/js/bootstrap-notify.min.js"></script>
<script type="text/javascript" src="js/dashboard.js"></script>

</body>

<!--Remove Timer Modal-->
<div id="removeTimer" class="modalDialog">
    <div>
        <a href="#close" title="Close" class="close"><img src="img/mobile/cancel.png"></a>

        <div class="modal-header">
            <h3>Remove Timer?</h3>
        </div>
        <div class="modal-body">
            Are You Sure You want to Remove the Timer?
        </div>
        <div id="modalError" class="modal-body" style="visibility: hidden ">
            <p style="color: darkred">Internal Error Occurred</p>
        </div>
        <div class="modal-footer">
            <a href="#close" title="Close">
                <button class="btn-normal btn-cancel">Cancel</button>
            </a>
            <button id="yesButton" class="btn-normal btn-secondary next-btn">Yes</button>
        </div>
    </div>
</div>
<script>
    var dashboard = {};
    var timersList = {};
    var aliasMap = JSON.parse(getKey("aliasMap"));


    $(document).ready(function () {
        $.ajax({
            type: 'POST',
            dataType: "json",
            contentType: "application/json",
            url: settings.dashboardUrl,
            headers: {
                Accept: 'application/json',
                Authorization: 'Bearer ' + getKey("dashboardToken")
            },
            success: function (data) {

                if (data['status'] == "ATW-S1000") {
                    if (data["result"] == null) {
                        $.notify({
                            title: '<p class="text-center-notify">Dashboard is empty</p>',
                            message: '<p class="text-center-notify">Please go to wizard page to configure your dashboard</p>'
                        }, {
                            type: 'warning',
                            delay: '500',
                            z_index: 1,
                            placement: {
                                from: "bottom",
                                align: "center"
                            },
                            animate: {
                                enter: "animated fadeInUp",
                                exit: "animated fadeOutDown"
                            }
                        });
                    } else {
                        setKey("dashboard", JSON.stringify(data["result"]));
                        init();
                    }
                } else {
                    $.notify({
                        title: '<p class="text-center-notify">Sorry</p>',
                        message: '<p class="text-center-notify">Internal error occurred.</p>'
                    }, {
                        type: 'danger',
                        delay: '500',
                        z_index: 1,
                        placement: {
                            from: "bottom",
                            align: "center"
                        },
                        animate: {
                            enter: "animated fadeInUp",
                            exit: "animated fadeOutDown"
                        }
                    });
                }
            },
            error: function (err) {
                console.log("An error Occurred====>" + err.toString());
                $.notify({
                    title: '<p class="text-center-notify">Sorry</p>',
                    message: '<p class="text-center-notify">Internal error occurred.</p>'
                }, {
                    type: 'danger',
                    delay: '500',
                    z_index: 1,
                    placement: {
                        from: "bottom",
                        align: "center"
                    },
                    animate: {
                        enter: "animated fadeInUp",
                        exit: "animated fadeOutDown"
                    }
                });

            }
        });
    });

    function init() {
        var divString = '';
        dashboard = JSON.parse(getKey("dashboard"));
        timersList = dashboard.timers;
        if (jQuery.isEmptyObject(timersList)) {
            $.notify({
                title: '<p class="text-center-notify">No Timers</p>',
                message: '<p class="text-center-notify">Go to Set Timers page to add timers.</p>'
            }, {
                type: 'info',
                delay: '5000',
                z_index: 1,
                placement: {
                    from: "bottom",
                    align: "center"
                },
                animate: {
                    enter: "animated fadeInUp",
                    exit: "animated fadeOutDown"
                }
            });

        } else {
            for (var timer in timersList) {
                var timerDetails = timersList[timer];
                var items = timerDetails.items;
                var repeats = timerDetails.repeat;
                var name = '';
                var repeatString = '';
                for (var i = 0; i < items.length; i++) {
                    if (i == items.length - 1) {
                        name += aliasMap[items[i]];
                    } else {
                        name += aliasMap[items[i]] + ', ';
                    }
                }

                for (var i = 0; i < repeats.length; i++) {
                    if (i == repeats.length - 1) {
                        repeatString += repeats[i];
                    } else {
                        repeatString += repeats[i] + ', ';
                    }
                }
                divString += '<div id="div_' + timer + '" class="device-card">' +
                        '<div class="device-card-header">' +
                        '<h4>' + name + '</h4>' +
                        '<p><img src="img/mobile/calendar.png">' + repeatString + '</p>' +
                        ' </div>' +
                        '<div class="device-card-body">' +
                        '<div class="device-card-time-area">' +
                        '<div class="device-clock">' +
                        '<img src="img/mobile/clock.png">' +
                        '</div>' +
                        '<div class="device-active-time">' +
                        '<p><span class="device-active-time--on">ON:</span>' + timerDetails.onTime + '</p>' +
                        '<p><span class="device-active-time--off">OFF:</span>' + timerDetails.offTime + '</p>' +
                        '</div>' +
                        '</div>' +
                        '<div class="device-card-switch-area">' +
                        '<a href="#removeTimer "><img src="img/mobile/delete.png">' +
                        '<button id="' + timer + '" class="btn-remover btn-transparent remover" onclick="remover(\'' + timer + '\')">Remove</button>' +
                        '</a></div></div></div>';
            }
            $('.iot-app-block').html(divString);
        }
    }

    function remover(timer) {
        console.log("remover clicked");
        document.getElementById("modalError").style.visibility = 'hidden';
        $("#removeTimer").show();
        $("#removeTimer").find(".next-btn").attr('id', 'yesButton_' + timer);
    }

    $('.next-btn').click(function (event) {
        var buttonId = event.target.id;
        var id = buttonId.split('_')[1];

        $.ajax({
            type: 'POST',
            dataType: "json",
            contentType: "application/json",
            url: settings.dashboardUrl + "/" + JSON.parse(getKey("dashboard")).id + "/unsetTimer/" + id,
            headers: {
                Accept: 'application/json',
                Authorization: 'Bearer ' + getKey("dashboardToken")
            },
            success: function (data) {
                if (data['status'] == "ATW-S1000") {
                    console.log(data);
                    $('#div_' + id).remove();
                    delete timersList[id];
                    $(".modalDialog").hide();
                    $.notify({
                        message: '<p class="text-center-notify">Timer is removed successfully</p>'
                    }, {
                        type: 'info',
                        delay: '500',
                        z_index: 1,
                        placement: {
                            from: "bottom",
                            align: "center"
                        },
                        animate: {
                            enter: "animated fadeInUp",
                            exit: "animated fadeOutDown"
                        }
                    });
                    if (jQuery.isEmptyObject(timersList)) {
                        $.notify({
                            title: '<p class="text-center-notify">No Timers</p>',
                            message: '<p class="text-center-notify">Go to Set Timers page to add timers.</p>'
                        }, {
                            type: 'info',
                            delay: '5000',
                            z_index: 1,
                            placement: {
                                from: "bottom",
                                align: "center"
                            },
                            animate: {
                                enter: "animated fadeInUp",
                                exit: "animated fadeOutDown"
                            }
                        });
                    }

                } else {
                    console.log(data);
                    document.getElementById("modalError").style.visibility = 'visible';
                }
            },
            error: function (err) {
                console.log(err);
                document.getElementById("modalError").style.visibility = 'visible';

            }
        });

    });
</script>
</html>