<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=EmulateIE9">
    <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0' name='viewport'/>
    <title>AppThing</title>
    <link rel="icon" type="image/png" href="img/mobile/favicon.ico">

    <!--Fonts CSS-->
    <link rel="stylesheet" type="text/css" href="css/roboto.css">
    <link rel="stylesheet" type="text/css" href="css/raleway.css">
    <link rel="stylesheet" type="text/css" href="css/open-sans.css">
    <link rel="stylesheet" type="text/css" href="css/font-awesome.min.css"/>
    <link rel="stylesheet" type="text/css" href="css/bootstrap-3.3.6/css/bootstrap.min.css">

    <!--Custom CSS-->
    <link rel="stylesheet" type="text/css" href="css/iot-app.css">


</head>
<body>
<header>
    <div id="container">
        <input id="toggle" type="checkbox"><label for="toggle">&equiv;</label>

        <div class="content">
            <div class="header-topic">Set Timer</div>
        </div>
        <div class="slide-menu">
            <div class="slide-menu__logo">
                <img src="img/mobile/logo-48x48.png">

                <h2>AppThing Dashboard</h2>
            </div>
            <nav class="menu">
                <li><a href="./things.html">Things</a></li>
                <li><a href="./view-timers.html">View Timers</a></li>
                <li><a href="./set-timer.html">Set Timer</a></li>
                <li><a href="./history.html">History</a></li>
                <li><a id="logout" href="index.html">Log Out</a></li>
            </nav>
        </div>
    </div>
</header>
<div class="iot-app-block">
    <div class="device-set-timer">
        <div class="device-set-timer-banner"></div>
        <table>
            <tbody>
            <tr>
                <td width="50">Device</td>
                <td width="100">
                    <a href="#multiple-devices">
                        <button class="btn-default">Select Device</button>
                    </a>
                </td>
            </tr>
            <tr>
                <td>On Time</td>
                <td class="device-set-timer__time-save">
                    <select id="onTimerHour" class="timeSelectors">
                        <option>12</option>
                        <option>01</option>
                        <option>02</option>
                        <option>03</option>
                        <option>04</option>
                        <option>05</option>
                        <option>06</option>
                        <option>07</option>
                        <option>08</option>
                        <option>09</option>
                        <option>10</option>
                        <option>11</option>
                    </select>

                    <select id="onTimerMinutes" class="timeSelectors">
                        <option>00</option>
                        <option>01</option>
                        <option>02</option>
                        <option>03</option>
                        <option>04</option>
                        <option>05</option>
                        <option>06</option>
                        <option>07</option>
                        <option>08</option>
                        <option>09</option>
                        <option>10</option>
                        <option>11</option>
                        <option>12</option>
                        <option>13</option>
                        <option>14</option>
                        <option>15</option>
                        <option>16</option>
                        <option>17</option>
                        <option>18</option>
                        <option>19</option>
                        <option>20</option>
                        <option>21</option>
                        <option>22</option>
                        <option>23</option>
                        <option>24</option>
                        <option>25</option>
                        <option>26</option>
                        <option>27</option>
                        <option>28</option>
                        <option>29</option>
                        <option>30</option>
                        <option>31</option>
                        <option>32</option>
                        <option>33</option>
                        <option>34</option>
                        <option>35</option>
                        <option>36</option>
                        <option>37</option>
                        <option>38</option>
                        <option>39</option>
                        <option>40</option>
                        <option>41</option>
                        <option>42</option>
                        <option>43</option>
                        <option>44</option>
                        <option>45</option>
                        <option>46</option>
                        <option>47</option>
                        <option>48</option>
                        <option>49</option>
                        <option>50</option>
                        <option>51</option>
                        <option>52</option>
                        <option>53</option>
                        <option>54</option>
                        <option>55</option>
                        <option>56</option>
                        <option>57</option>
                        <option>58</option>
                        <option>59</option>
                    </select>

                    <select id="onTimerPeriod" class="timeSelectors">
                        <option>AM</option>
                        <option>PM</option>
                    </select>
                </td>
            </tr>

            <tr>
                <td>Off Time</td>
                <td class="device-set-timer__time-save">
                    <select id="offTimerHour" class="timeSelectors">
                        <option>12</option>
                        <option>01</option>
                        <option>02</option>
                        <option>03</option>
                        <option>04</option>
                        <option>05</option>
                        <option>06</option>
                        <option>07</option>
                        <option>08</option>
                        <option>09</option>
                        <option>10</option>
                        <option>11</option>
                    </select>

                    <select id="offTimerMinutes" class="timeSelectors">
                        <option>00</option>
                        <option>01</option>
                        <option>02</option>
                        <option>03</option>
                        <option>04</option>
                        <option>05</option>
                        <option>06</option>
                        <option>07</option>
                        <option>08</option>
                        <option>09</option>
                        <option>10</option>
                        <option>11</option>
                        <option>12</option>
                        <option>13</option>
                        <option>14</option>
                        <option>15</option>
                        <option>16</option>
                        <option>17</option>
                        <option>18</option>
                        <option>19</option>
                        <option>20</option>
                        <option>21</option>
                        <option>22</option>
                        <option>23</option>
                        <option>24</option>
                        <option>25</option>
                        <option>26</option>
                        <option>27</option>
                        <option>28</option>
                        <option>29</option>
                        <option>30</option>
                        <option>31</option>
                        <option>32</option>
                        <option>33</option>
                        <option>34</option>
                        <option>35</option>
                        <option>36</option>
                        <option>37</option>
                        <option>38</option>
                        <option>39</option>
                        <option>40</option>
                        <option>41</option>
                        <option>42</option>
                        <option>43</option>
                        <option>44</option>
                        <option>45</option>
                        <option>46</option>
                        <option>47</option>
                        <option>48</option>
                        <option>49</option>
                        <option>50</option>
                        <option>51</option>
                        <option>52</option>
                        <option>53</option>
                        <option>54</option>
                        <option>55</option>
                        <option>56</option>
                        <option>57</option>
                        <option>58</option>
                        <option>59</option>
                    </select>

                    <select id="offTimerPeriod" class="timeSelectors">
                        <option>AM</option>
                        <option>PM</option>
                    </select>
                </td>
            </tr>

            <tr>
                <td>Repeat</td>
                <td class="device-set-timer__repeat">
                    <select id="repeat" class="timeSelectors">
                        <option>Do Not Repeat</option>
                        <option>Everyday</option>
                        <option>Mon - Fri</option>
                        <option>Custom</option>
                    </select>
                    <a href="#custom-repeat">
                        <button class="btn-default">Custom</button>
                    </a>
                </td>
            </tr>
            </tbody>
        </table>
        <div class="text-center action-buttons">
            <button id="saveButton" class="btn-normal btn-secondary">Save</button>
            <button id="clearButton" class="btn-normal btn-cancel">Clear</button>
        </div>
    </div>
</div>

<script type="text/javascript" src="js/jquery-1.11.3.min.js"></script>
<script type="text/javascript" src="js/bootstrap-3.3.6/js/bootstrap-notify.min.js"></script>
<script type="text/javascript" src="js/bootstrap-3.3.6/js/bootstrap.min.js"></script>
<script type="text/javascript" src="js/dashboard.js"></script>
</body>

<!--Select Devices Modal-->
<div id="multiple-devices" class="modalDialog">
    <div>
        <a href="#close" title="Close" class="close"><img src="img/mobile/cancel.png"></a>

        <div class="modal-header">
            <h3>Devices</h3>
        </div>
        <div id="selectDevices" class="modal-body modal-body__custom-repeat"></div>
        <div class="modal-footer">
            <a href="#close">
                <button class="btn-normal btn-secondary next-btn">OK</button>
            </a>
        </div>
    </div>
</div>

<!--Remove Timer Modal-->
<div id="custom-repeat" class="modalDialog">
    <div>
        <a href="#close" title="Close" class="close"><img src="img/mobile/cancel.png"></a>

        <div class="modal-header">
            <h3>Select Custom Day(s)</h3>
        </div>
        <div class="modal-body modal-body__custom-repeat">
            <ul>
                <li>
                    <div class="modal-body__checkbox">
                        <div class="squaredOne">
                            <input class="day" type="checkbox" value="None" id="SUNDAY" name="check"/>
                            <label for="SUNDAY"></label>
                        </div>
                    </div>
                    <div class="modal-body__checkbox-label">Sunday</div>
                </li>
                <li>
                    <div class="modal-body__checkbox">
                        <div class="squaredOne">
                            <input class="day" type="checkbox" value="None" id="MONDAY" name="check"/>
                            <label for="MONDAY"></label>
                        </div>
                    </div>
                    <div class="modal-body__checkbox-label">Monday</div>
                </li>
                <li>
                    <div class="modal-body__checkbox">
                        <div class="squaredOne">
                            <input class="day" type="checkbox" value="None" id="TUESDAY" name="check"/>
                            <label for="TUESDAY"></label>
                        </div>
                    </div>
                    <div class="modal-body__checkbox-label">Tuesday</div>
                </li>
                <li>
                    <div class="modal-body__checkbox">
                        <div class="squaredOne">
                            <input class="day" type="checkbox" value="None" id="WEDNESDAY" name="check"/>
                            <label for="WEDNESDAY"></label>
                        </div>
                    </div>
                    <div class="modal-body__checkbox-label">Wednesday</div>
                </li>
                <li>
                    <div class="modal-body__checkbox">
                        <div class="squaredOne">
                            <input class="day" type="checkbox" value="None" id="THURSDAY" name="check"/>
                            <label for="THURSDAY"></label>
                        </div>
                    </div>
                    <div class="modal-body__checkbox-label">Thursday</div>
                </li>
                <li>
                    <div class="modal-body__checkbox">
                        <div class="squaredOne">
                            <input class="day" type="checkbox" value="None" id="FRIDAY" name="check"/>
                            <label for="FRIDAY"></label>
                        </div>
                    </div>
                    <div class="modal-body__checkbox-label">Friday</div>
                </li>
                <li>
                    <div class="modal-body__checkbox">
                        <div class="squaredOne">
                            <input class="day" type="checkbox" value="None" id="SATURDAY" name="check"/>
                            <label for="SATURDAY"></label>
                        </div>
                    </div>
                    <div class="modal-body__checkbox-label">Saturday</div>
                </li>
            </ul>
        </div>
        <div class="modal-footer">
            <a href="#close">
                <button class="btn-normal btn-secondary next-btn">OK</button>
            </a>
        </div>
    </div>
</div>
<script>
    var listString = '<ul>';
    var aliasMap = JSON.parse(getKey("aliasMap"));

    $(document).ready(function () {
        for (var key in aliasMap) {
            listString += '<li><div class="modal-body__checkbox"><div class="squaredOne">' +
                    '<input type="checkbox" value="None" id="' + key + '" name="check"/>' +
                    '<label for="' + key + '"></label></div></div> ' +
                    '<div class="modal-body__checkbox-label">' + aliasMap[key] + '</div></li>';
        }
        listString += '</ul>';
        $('#selectDevices').html(listString);
    });

    $("#saveButton").click(function (event) {

        var onTime = $("#onTimerHour option:selected").text() + ":"
                + $("#onTimerMinutes option:selected").text() + ":"
                + $("#onTimerPeriod option:selected").text();

        var offTime = $("#offTimerHour option:selected").text() + ":"
                + $("#offTimerMinutes option:selected").text() + ":"
                + $("#offTimerPeriod option:selected").text();

        var repeatSelect = $("#repeat option:selected").text();

        var repeat = [];
        var checkedKeys = 0;
        var checkedDays = 0;

        if (repeatSelect == "Do Not Repeat") {
            repeat.push("ONETIME");
            checkedDays = 1;
        } else if (repeatSelect == "Everyday") {
            repeat.push("EVERYDAY");
            checkedDays = 7;
        } else if (repeatSelect == "Mon - Fri") {
            repeat.push("WEEKDAYS");
            checkedDays = 5;
        } else if (repeatSelect == "Custom") {
            var days = document.getElementsByClassName("day");
            for (var i = 0; i < days.length; i++) {
                if (days[i].checked) {
                    repeat.push($(days[i]).attr('id'));
                    checkedDays++;
                }
            }
        }

        var message = {
            id: "#",
            items: [],
            onTime: onTime,
            offTime: offTime,
            repeat: repeat,
            status: "pending"
        };

        for (var key in aliasMap) {
            if (document.getElementById(key).checked) {
                message.items[checkedKeys] = key;
                checkedKeys++;
            }
        }
        if (checkedKeys > 0 && checkedDays > 0) {
            $.ajax({
                type: 'POST',
                dataType: "json",
                data: JSON.stringify(message),
                contentType: "application/json",
                url: settings.dashboardUrl + "/" + JSON.parse(getKey("dashboard")).id + "/setTimer",
                headers: {
                    Accept: 'application/json',
                    Authorization: 'Bearer ' + getKey("dashboardToken")
                },
                success: function (data) {
                    if (data['status'] == "ATW-S1000") {
                        console.log(data);
                        $.notify({
                            message: '<p class="text-center-notify">Timer is set Successfully.</p>'
                        }, {
                            type: 'info',
                            delay: '500',
                            z_index: 1,
                            placement: {
                                from: "bottom",
                                align: "center"
                            },
                            animate: {
                                enter: "animated fadeInUp",
                                exit: "animated fadeOutDown"
                            }
                        });
                    } else {
                        console.log(data);
                        $.notify({
                            title: '<p class="text-center-notify">Sorry</p>',
                            message: '<p class="text-center-notify">' + data.description + '</p>'
                        }, {
                            type: 'danger',
                            delay: '500',
                            z_index: 1,
                            placement: {
                                from: "bottom",
                                align: "center"
                            },
                            animate: {
                                enter: "animated fadeInUp",
                                exit: "animated fadeOutDown"
                            }
                        });
                    }
                },
                error: function (err) {
                    console.log(err);
                    $.notify({
                        title: '<p class="text-center-notify">Sorry</p>',
                        message: '<p class="text-center-notify">Internal error occurred.</p>'
                    }, {
                        type: 'danger',
                        delay: '500',
                        z_index: 1,
                        placement: {
                            from: "bottom",
                            align: "center"
                        },
                        animate: {
                            enter: "animated fadeInUp",
                            exit: "animated fadeOutDown"
                        }
                    });
                }
            });
        } else if (checkedKeys == 0) {
            $.notify({
                message: '<p class="text-center-notify">No devices selected</p>'
            }, {
                type: 'warning',
                delay: '200',
                z_index: 1,
                placement: {
                    from: "bottom",
                    align: "center"
                },
                animate: {
                    enter: "animated fadeInUp",
                    exit: "animated fadeOutDown"
                }
            });
        } else {
            $.notify({
                message: '<p class="text-center-notify">Select atleast one day from the list</p>'
            }, {
                type: 'warning',
                delay: '200',
                z_index: 1,
                placement: {
                    from: "bottom",
                    align: "center"
                },
                animate: {
                    enter: "animated fadeInUp",
                    exit: "animated fadeOutDown"
                }
            });
        }
    });

    $("#clearButton").click(function (event) {
        $(".timeSelectors").prop('selectedIndex', 0);
        $("input:checkbox").removeAttr('checked');
    });

</script>

</html>