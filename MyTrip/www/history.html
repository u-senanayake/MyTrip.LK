<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=EmulateIE9"/>
    <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0' name='viewport'/>
    <title>AppThing</title>
    <link rel="icon" type="image/png" href="img/mobile/favicon.ico"/>

    <!--Fonts CSS-->
    <link rel="stylesheet" type="text/css" href="css/roboto.css"/>
    <link rel="stylesheet" type="text/css" href="css/raleway.css"/>
    <link rel="stylesheet" type="text/css" href="css/open-sans.css"/>
    <link rel="stylesheet" type="text/css" href="css/font-awesome.min.css"/>
    <link rel="stylesheet" type="text/css" href="css/bootstrap-3.3.6/css/bootstrap.min.css">

    <!--Custom CSS-->
    <link rel="stylesheet" type="text/css" href="css/iot-app.css"/>
    <!--Scripts-->
</head>
<body>
<div id="loading"></div>
<header>
    <div id="container">
        <input id="toggle" type="checkbox"/><label for="toggle">&equiv;</label>

        <div class="content">
            <div class="header-topic">History</div>
        </div>
        <div class="slide-menu">
            <div class="slide-menu__logo">
                <img src="img/mobile/logo-48x48.png"/>

                <h2>AppThing Dashboard</h2>
            </div>
            <div id="navigation">
                <nav class="menu">
                    <li><a href="./things.html">Things</a></li>
                    <li><a href="./view-timers.html">View Timers</a></li>
                    <li><a href="./set-timer.html">Set Timer</a></li>
                    <li><a href="./history.html">History</a></li>
                    <li><a id="logout" href="index.html">Log Out</a></li>
                </nav>
            </div>
        </div>
    </div>
</header>
<div class="iot-app-block">
    <div class="iot-history">
        <table>
            <tbody>
            <tr>
                <td>Notifications</td>
                <td id="notificationStatus">
                </td>
            </tr>
            </tbody>
        </table>
        <div id="page">
            <div id="eventTablePlace"></div>
        </div>
    </div>
</div>
<script type="text/javascript" src="js/jquery-1.11.3.min.js"></script>
<script type="text/javascript" src="js/mustache.js"></script>
<script type="text/javascript" src="js/bootstrap-3.3.6/js/bootstrap-notify.min.js"></script>
<script type="text/javascript" src="js/bootstrap-3.3.6/js/bootstrap.min.js"></script>
<script type="text/javascript" src="js/dashboard.js"></script>
<script type="text/javascript" src="js/dashboard-util.js"></script>
</body>
<script>
    var xhr = new XMLHttpRequest();
    xhr.open("POST", settings.eventUrl, true);
    xhr.setRequestHeader("Content-Type", "application/json");

    $(document).ready(function () {
        var tableStr;
        var eventSummary;
        console.log("Dashboard token is ===========> " + getKey("dashboardToken"));

        if (getKey("isChecked") === "true") {
            tableStr = '<label class="switch switch-flat">' +
                    '<input class="switch-input" type="checkbox" id="activate" onclick="notificationHandler(this)" checked/>' +
                    '<span class="switch-label" data-on="On" data-off="Off" for="activate"></span>' +
                    '<span class="switch-handle"></span>' +
                    '</label>';
        } else {
            tableStr = '<label class="switch switch-flat">' +
                    '<input class="switch-input" type="checkbox" id="activate" onclick="notificationHandler(this)" />' +
                    '<span class="switch-label" data-on="On" data-off="Off" for="activate"></span>' +
                    '<span class="switch-handle"></span>' +
                    '</label>';
        }
        $("#notificationStatus").html(tableStr);

        $.ajax({
            type: 'POST',
            url: settings.eventUrl,
            dataType: "json",
            contentType: "application/json",
            headers: {
                Accept: 'application/json',
                Authorization: 'Bearer ' + getKey("dashboardToken")
            },
            beforeSend: function () {
                xhr.setRequestHeader("Authorization", "Bearer " + getKey("dashboardToken"));
            },
            success: function (data) {
                if (data['status'] == "ATW-S1000") {
                    console.log("Got Events===========> " + JSON.stringify(data));
                    eventSummary = data;
                    var numberOfEvents = Object.keys(eventSummary["result"]);
                    var events = eventSummary["result"];
                    console.log('number' + numberOfEvents);
                    console.log('number2' + events);
                    var count = 0;

                    for (var i = 0; i < events.length; i++) {
                        count = count + events[i]["eventsList"].length;
                        console.log(events[i]["eventsList"]);
                    }

                    if (count == 0) {
                        $.notify({
                            title: '<p class="text-center-notify">History is empty</p>',
                            message: "<p class='text-center-notify'>You don't have any event to display.</p>"
                        }, {
                            type: 'info',
                            delay: '4000',
                            z_index: 1,
                            placement: {
                                from: "bottom",
                                align: "center"
                            },
                            animate: {
                                enter: "animated fadeInUp",
                                exit: "animated fadeOutDown"
                            }
                        });
                    }
                    var eventsTemplate = $('#eventTable').html();
                    var html2 = Mustache.to_html(eventsTemplate, eventSummary);
                    $('#eventTablePlace').html(html2);
                } else {
                    $.notify({
                        title: '<strong class=text-center-notify>SORRY !</strong>',
                        message: '<p class="text-center-notify">Internal error occurred. Try again Later.</p>'
                    }, {
                        type: 'danger',
                        delay: '5000',
                        z_index: 1,
                        placement: {
                            from: "bottom",
                            align: "center"
                        },
                        animate: {
                            enter: "animated fadeInUp",
                            exit: "animated fadeOutDown"
                        }
                    });
                }
            },
            error: function (err) {
                console.log("=====>Error occurred");
                $.notify({
                    title: '<strong class=text-center-notify>SORRY !</strong>',
                    message: '<p class="text-center-notify">Internal error occurred. Try again Later.</p>'
                }, {
                    type: 'danger',
                    delay: '1000',
                    z_index: 1,
                    placement: {
                        from: "bottom",
                        align: "center"
                    },
                    animate: {
                        enter: "animated fadeInUp",
                        exit: "animated fadeOutDown"
                    }
                });
            }
        });
    });
</script>

<script id="eventTable" type="text/template">
    <div>{{#result}}
        <div class="table-topic">{{day}}</div>
        <table>{{#eventsList}}
            <tbody>
            <tr>
                <td width="70" class="text-center" rowspan="3">
                    <img src="{{imgPath}}"/>

                    <div>{{deviceName}}</div>

                    {{#status}}
                    <div class="device-status text-center">
                        <span class="device-status--on">ON</span>
                    </div>
                    {{/status}}
                    {{^status}}
                    <div class="device-status text-center">
                        <span class="device-status--off">OFF</span>
                    </div>
                    {{/status}}
                </td>
                <td width="100">
                    <span class="iot-history__incident">Controller:</span>
                    <span class="iot-history__incident--result">{{user}}</span>
                </td>
            </tr>
            <tr>
                <td>
                    <span class="iot-history__incident">Time:</span>
                    <span class="iot-history__incident--result">{{hour}}</span>
                </td>
            </tr>
            <tr>
                <td>
                    <span class="iot-history__incident">Channel:</span>
                    <span class="iot-history__incident--result">{{channel}}</span>
                </td>
            </tr>
            </tbody>
            {{/eventsList}}
        </table>
        {{/result}}
    </div>
</script>

<!--Common Bulb Modal-->
<div id="common-bulb" class="modalDialog">
    <div>
        <a href="#close" title="Close" class="close"><img src="img/mobile/cancel.png"/></a>

        <div class="modal-header">
            <h3>Devices</h3>
        </div>
        <div class="modal-body modal-body-with-list">
            <p><span class="modal-bullet-icon"></span>Garden Bulb</p>

            <p><span class="modal-bullet-icon"></span>Living Room Bulb</p>
        </div>
    </div>
</div>


</html>